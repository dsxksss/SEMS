<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sems.sportseventmanagementsystem.mapper.RegistrationMapper">
    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.sems.sportseventmanagementsystem.model.entity.Registration">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="event_id" property="eventId" />
        <result column="registration_type" property="registrationType" />
        <result column="status" property="status" />
        <result column="register_time" property="registerTime" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
    </resultMap>
    
    <!-- 包含用户和赛事信息的结果映射 -->
    <resultMap id="RegistrationWithUserAndEventMap" type="com.sems.sportseventmanagementsystem.model.entity.Registration" extends="BaseResultMap">
        <association property="user" javaType="com.sems.sportseventmanagementsystem.model.entity.User">
            <id column="u_id" property="id" />
            <result column="u_username" property="username" />
            <result column="u_real_name" property="realName" />
            <result column="u_email" property="email" />
            <result column="u_phone" property="phone" />
        </association>
        <association property="event" javaType="com.sems.sportseventmanagementsystem.model.entity.Event">
            <id column="e_id" property="id" />
            <result column="e_name" property="name" />
            <result column="e_description" property="description" />
            <result column="e_start_time" property="startTime" />
            <result column="e_end_time" property="endTime" />
            <result column="e_location" property="location" />
            <result column="e_status" property="status" />
        </association>
    </resultMap>
    
    <!-- 包含赛事信息的结果映射 -->
    <resultMap id="RegistrationWithEventMap" type="com.sems.sportseventmanagementsystem.model.entity.Registration" extends="BaseResultMap">
        <association property="event" javaType="com.sems.sportseventmanagementsystem.model.entity.Event">
            <id column="e_id" property="id" />
            <result column="e_name" property="name" />
            <result column="e_description" property="description" />
            <result column="e_start_time" property="startTime" />
            <result column="e_end_time" property="endTime" />
            <result column="e_location" property="location" />
            <result column="e_status" property="status" />
        </association>
    </resultMap>
    
    <!-- 包含用户信息的结果映射 -->
    <resultMap id="RegistrationWithUserMap" type="com.sems.sportseventmanagementsystem.model.entity.Registration" extends="BaseResultMap">
        <association property="user" javaType="com.sems.sportseventmanagementsystem.model.entity.User">
            <id column="u_id" property="id" />
            <result column="u_username" property="username" />
            <result column="u_real_name" property="realName" />
            <result column="u_email" property="email" />
            <result column="u_phone" property="phone" />
        </association>
    </resultMap>
    
    <!-- 查询带有用户和赛事信息的报名记录 -->
    <select id="selectWithUserAndEventById" resultMap="RegistrationWithUserAndEventMap">
        SELECT 
            r.*, 
            u.id as u_id, u.username as u_username, u.real_name as u_real_name, u.email as u_email, u.phone as u_phone,
            e.id as e_id, e.name as e_name, e.description as e_description, e.start_time as e_start_time, 
            e.end_time as e_end_time, e.location as e_location, e.status as e_status
        FROM registration r
        LEFT JOIN user u ON r.user_id = u.id
        LEFT JOIN event e ON r.event_id = e.id
        WHERE r.id = #{id}
    </select>
    
    <!-- 查询用户的报名记录（包含赛事信息） -->
    <select id="selectWithEventByUserId" resultMap="RegistrationWithEventMap">
        SELECT 
            r.*, 
            e.id as e_id, e.name as e_name, e.description as e_description, e.start_time as e_start_time, 
            e.end_time as e_end_time, e.location as e_location, e.status as e_status
        FROM registration r
        LEFT JOIN event e ON r.event_id = e.id
        WHERE r.user_id = #{userId}
        ORDER BY r.register_time DESC
    </select>
    
    <!-- 查询赛事的报名记录（包含用户信息） -->
    <select id="selectWithUserByEventId" resultMap="RegistrationWithUserMap">
        SELECT 
            r.*, 
            u.id as u_id, u.username as u_username, u.real_name as u_real_name, u.email as u_email, u.phone as u_phone
        FROM registration r
        LEFT JOIN user u ON r.user_id = u.id
        WHERE r.event_id = #{eventId}
        ORDER BY r.register_time ASC
    </select>
</mapper> 